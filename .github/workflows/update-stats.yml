name: Update Stats with Private Repos

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  refresh-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Test Token First
        run: |
          echo "🔍 Testing token authentication..."
          response=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.GH_TOKEN }}" https://api.github.com/user)
          status_code=${response: -3}
          response_body=${response%???}
          
          echo "HTTP Status: $status_code"
          if [ "$status_code" = "200" ]; then
            echo "✅ Token is valid and working!"
            login=$(echo "$response_body" | grep -o '"login": "[^"]*' | cut -d'"' -f4)
            echo "Authenticated as: $login"
          else
            echo "❌ Token authentication failed!"
            echo "Error response: $response_body"
            echo "Please check:"
            echo "1. Token has 'repo' permissions"
            echo "2. Secret is named exactly 'GH_TOKEN'"
            echo "3. Token is not expired"
            exit 1
          fi

      - name: Debug - Test Stats API
        run: |
          echo "🔍 Testing stats API without token..."
          response=$(curl -s -w "%{http_code}" "https://github-readme-stats.vercel.app/api?username=sjolliff&show_icons=true")
          echo "Public API status: ${response: -3}"
          
          echo "Testing stats API with token..."
          response=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://github-readme-stats.vercel.app/api?username=sjolliff&show_icons=true&count_private=true")
          echo "Private API status: ${response: -3}"

      - name: Refresh with Token
        run: |
          echo "🔄 Refreshing stats with token..."
          # Refresh stats with token authentication
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://github-readme-stats.vercel.app/api?username=sjolliff&show_icons=true&theme=radical&count_private=true&include_all_commits=true&random=${{ github.run_id }}" > /dev/null
          
          # Refresh languages with token
          curl -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://github-readme-stats.vercel.app/api/top-langs/?username=sjolliff&layout=compact&theme=radical&hide_progress=false&count_private=true&random=${{ github.run_id }}" > /dev/null
          
          echo "✅ Stats refresh attempted!"
          echo "Note: It may take 15-30 minutes for changes to appear on your README"
          echo "The API caches results for performance reasons"

      - name: Final Status
        run: |
          echo "📊 Debug completed!"
          echo "Check your README in 30 minutes"
          echo "If stats still don't show, try:"
          echo "1. Removing '&count_private=true' temporarily"
          echo "2. Using a simpler theme like '&theme=default'"
          echo "3. Checking GitHub Actions logs for errors"
